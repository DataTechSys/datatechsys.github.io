<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <title>Admin Â· Invite Users</title>
        <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet"/>
        <style>
    body{background:#f6f7fb;}
    .page-card{border:0;border-radius:16px;box-shadow:0 6px 24px rgba(26,26,44,.06)}
  </style>
    </head>
    <body>
        <div class="container py-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h1 class="h4 mb-0">Invite Users</h1>
                <div class="d-flex gap-2"><a class="btn btn-outline-secondary btn-sm" href="dashboard.html">Dashboard</a><a class="btn btn-outline-secondary btn-sm" href="account.html">Account</a><a class="btn btn-outline-secondary btn-sm" href="super-admin.html">Super Admin</a>
                </div>
            </div>
            <div class="alert alert-info">
                Active Company: <strong id="coName"></strong> (<span id="coAcct"></span>)
            </div>
            <div class="card page-card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Invite by Email</h5>
                    <form id="inviteForm" class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Full Name</label>
                            <input class="form-control" id="invName" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="invEmail" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Role</label>
                            <select class="form-select" id="invRole" required>
                                <option value="owner">Owner</option>
                                <option value="admin" selected>Admin</option>
                                <option value="manager">Manager</option>
                                <option value="agent">Agent</option>
                                <option value="viewer">Viewer</option>
                            </select>
                        </div>
                        <div class="col-12 d-flex gap-2">
                            <button class="btn btn-primary" type="submit">Generate Invite Link</button><a id="mailtoBtn" class="btn btn-outline-secondary disabled" target="_blank">Send Email</a>
                            <button id="copyBtn" type="button" class="btn btn-outline-secondary disabled">Copy Link</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="card page-card">
                <div class="card-body">
                    <h5 class="card-title">Pending Invites</h5>
                    <div class="table-responsive">
                        <table class="table align-middle" id="invitesTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Link</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <script src="bootstrap/js/bootstrap.min.js"></script>
        <script src="js/app-auth.js"></script>
        <script>
  // Must be logged in; must have permission to invite
  RBAC.requireAuth();
  const me = RBAC.currentUser();
  if (!RBAC.can('user:invite', me?.role) && !RBAC.isSuper()) {
    alert('No permission to invite users.'); window.location.replace('dashboard.html');
  }

  // Tenant from query or active
  const urlTenant = new URLSearchParams(location.search).get('tenantId');
  if (urlTenant) RBAC.setActiveTenant(urlTenant);
  const tenant = RBAC.getTenant();
  if (!tenant) { alert('No active company'); window.location.replace('dashboard.html'); }

  document.getElementById('coName').textContent = tenant.name;
  document.getElementById('coAcct').textContent = tenant.accountId;

  // Local invite store
  const INV_KEY = 'invites';
  const _readInv = ()=> JSON.parse(localStorage.getItem(INV_KEY) || '[]');
  const _writeInv= (v)=> localStorage.setItem(INV_KEY, JSON.stringify(v));
  const _uuid    = ()=> 'tok-' + Math.random().toString(36).slice(2,10);

  const tbody = document.querySelector('#invitesTable tbody');

  function linkFor(token){
    const base = location.origin + location.pathname.replace('admin-invite.html','');
    return `${base}signup.html?tenantId=${tenant.id}&token=${token}`;
  }

  function renderInvites(){
    const invs = _readInv().filter(i=>i.tenantId===tenant.id);
    tbody.innerHTML = '';
    invs.forEach(i=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i.name}</td>
        <td>${i.email}</td>
        <td class="text-capitalize">${i.role}</td>
        <td class="text-truncate" style="max-width:360px"><a href="${linkFor(i.token)}" target="_blank">${linkFor(i.token)}</a></td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-secondary" data-copy="${i.token}">Copy</button>
          <button class="btn btn-sm btn-outline-danger" data-del="${i.token}">Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }
  renderInvites();

  const mailtoBtn = document.getElementById('mailtoBtn');
  const copyBtn   = document.getElementById('copyBtn');

  document.getElementById('inviteForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const name = invName.value.trim();
    const email= invEmail.value.trim();
    const role = invRole.value;

    const token= _uuid();
    const invites = _readInv();
    invites.push({ token, tenantId: tenant.id, name, email, role, createdAt: Date.now() });
    _writeInv(invites);
    renderInvites();

    const fullLink = `${linkFor(token)}&email=${encodeURIComponent(email)}&name=${encodeURIComponent(name)}&role=${encodeURIComponent(role)}`;
    const subject  = encodeURIComponent(`You're invited to ${tenant.name} Console`);
    const body     = encodeURIComponent(`Hi ${name},\n\nYou've been invited to ${tenant.name} Console as ${role}.\nClick to complete your account:\n\n${fullLink}\n\n(For demo, login password is 1234.)\n`);

    mailtoBtn.href = `mailto:${encodeURIComponent(email)}?subject=${subject}&body=${body}`;
    mailtoBtn.classList.remove('disabled');

    copyBtn.classList.remove('disabled');
    copyBtn.onclick = ()=> { navigator.clipboard.writeText(fullLink); copyBtn.textContent='Copied!'; setTimeout(()=>copyBtn.textContent='Copy Link',1200); };

    e.target.reset();
    alert('Invite link generated. You can email it or copy the link.');
  });

  tbody.addEventListener('click', (e)=>{
    const copy = e.target.closest('[data-copy]');
    const del  = e.target.closest('[data-del]');
    if (copy) { navigator.clipboard.writeText(linkFor(copy.getAttribute('data-copy'))); copy.textContent='Copied!'; setTimeout(()=>copy.textContent='Copy',1000); }
    if (del)  { const tok = del.getAttribute('data-del'); const remain = _readInv().filter(i=>i.token!==tok); localStorage.setItem(INV_KEY, JSON.stringify(remain)); renderInvites(); }
  });
</script>
    </body>
</html>
